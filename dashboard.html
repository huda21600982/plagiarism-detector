<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PlagAware ‚Äî AI Plagiarism Checker</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'purple-accent': '#7C3AED',
            'purple-accent-2': '#C084FC',
            'panel': '#F8FAFF',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] }
        }
      }
    }
  </script>
  <style>
    .heat-0 { background: linear-gradient(90deg,#ecfccb,#86efac); }
    .heat-1 { background: linear-gradient(90deg,#fef9c3,#facc15); }
    .heat-2 { background: linear-gradient(90deg,#fee2e2,#f43f5e); }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }

    /* highlight */
    mark.plag-mark { background: #fde68a; padding: 0 2px; border-radius: 4px; }
    .ai-warning { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>

<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">

  <!-- TOP NAVBAR -->
  <nav class="bg-white/90 dark:bg-gray-900/90 border-b dark:border-gray-800 backdrop-blur sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-9 h-9 rounded-lg bg-purple-accent text-white flex items-center justify-center font-bold text-lg">
          AI
        </div>
        <div>
          <div class="font-extrabold text-lg text-gray-900 dark:text-white">PlagAware</div>
          <div id="subTitle" class="text-xs text-gray-500 dark:text-gray-400">AI Plagiarism Dashboard</div>
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        <a href="index.html" id="navHome" class="hidden sm:inline-block px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
          Home
        </a>
        <a href="dashboard.html" id="navChecker" class="hidden sm:inline-block px-3 py-1 rounded-lg bg-purple-accent text-white font-semibold hover:opacity-95">
          Open Checker
        </a>

        <!-- Arabic toggle -->
        <button id="uiLangToggle" class="px-3 py-1 rounded-lg border dark:border-gray-700 bg-white dark:bg-gray-800 text-xs">
          AR
        </button>
        
        <!-- Stats Badge -->
        <div id="statsBadge" class="hidden sm:flex items-center gap-2 px-3 py-1 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 text-xs">
          <span id="totalScans">0</span> scans
        </div>
      </div>
    </div>
  </nav>

  <!-- Layout: Sidebar + Main -->
  <div class="min-h-screen flex">

    <!-- SIDEBAR -->
    <aside class="w-72 bg-white dark:bg-gray-800 border-r dark:border-gray-700 hidden md:block">
      <div class="p-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 rounded-lg bg-purple-accent flex items-center justify-center text-white font-bold">AI</div>
          <div>
            <h1 class="text-lg font-extrabold text-gray-900 dark:text-white">PlagAware</h1>
            <p id="sideSub" class="text-xs text-gray-500 dark:text-gray-400">AI Plagiarism Dashboard</p>
          </div>
        </div>

        <nav class="mt-8 space-y-2">
          <button id="nav_scan" class="w-full text-left px-3 py-2 rounded-lg bg-purple-accent-2/10 text-sm font-medium text-purple-accent hover:bg-purple-accent-2/20">Scan</button>
          <button id="nav_corpus" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">Corpus</button>
          <button id="nav_history" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">History</button>
          <button id="nav_stats" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">Statistics</button>
        </nav>

        <div class="mt-8">
          <p id="corpusSizeLabel" class="text-xs text-gray-500 dark:text-gray-400">Corpus size:</p>
          <div id="corpusCount" class="mt-2 text-sm font-semibold text-gray-700 dark:text-gray-200">‚Äî</div>
          <button id="rebuildBtn" class="mt-3 w-full px-3 py-2 bg-purple-accent text-white rounded-lg text-sm hover:opacity-95">Rebuild Index</button>
        </div>

        <!-- Batch Upload Section -->
        <div class="mt-8 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Batch Upload</p>
          <input type="file" id="batchFileInput" multiple class="hidden" accept=".pdf,.docx,.txt">
          <label for="batchFileInput" class="block w-full text-center px-3 py-2 rounded-lg border border-dashed border-gray-300 dark:border-gray-700 text-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800">
            üìÅ Upload Multiple Files
          </label>
          <div id="batchProgress" class="mt-2 hidden">
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div id="batchProgressBar" class="bg-purple-accent h-2 rounded-full" style="width: 0%"></div>
            </div>
            <div id="batchStatus" class="text-xs text-gray-500 mt-1"></div>
          </div>
        </div>

        <div class="mt-8 text-xs text-gray-400">AI Detection ‚Ä¢ Citation Generation ‚Ä¢ Multi-Language</div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="flex-1 p-6">

      <header class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <h2 id="pageTitle" class="text-xl font-bold text-gray-900 dark:text-white">Scan ¬∑ New</h2>
          <span id="pageHint" class="text-sm text-gray-500 dark:text-gray-400">Paste text or upload a document to detect plagiarism</span>
        </div>

        <div class="flex items-center space-x-4">
          <div class="hidden sm:flex items-center space-x-2 px-3 py-2 bg-white dark:bg-gray-800 rounded-lg border dark:border-gray-700">
            <label id="langLabel" class="text-xs text-gray-500 dark:text-gray-400 mr-2">Language (we'll translate)</label>
            <select id="languageSelect" class="text-sm bg-transparent outline-none">
              <option value="auto">Detect</option>
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="hi">Hindi</option>
              <option value="zh-cn">Chinese (Simplified)</option>
              <option value="ar">Arabic</option>
              <option value="ru">Russian</option>
            </select>
          </div>

          <div class="flex items-center space-x-3">
            <button id="themeToggle" class="p-2 rounded-md bg-white dark:bg-gray-800 shadow-sm" title="Toggle theme">
              <!-- Sun icon for light mode -->
              <svg id="sunIcon" class="w-5 h-5 text-yellow-500 hidden" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zM5.636 4.222a1 1 0 1 1 1.414-1.414L8.05 4.81a1 1 0 0 1-1.414 1.414L5.636 4.222zM2 12a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1z"/>
              </svg>
              <!-- Moon icon for dark mode -->
              <svg id="moonIcon" class="w-5 h-5 text-gray-700 dark:text-gray-200" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zM5.636 4.222a1 1 0 1 1 1.414-1.414L8.05 4.81a1 1 0 0 1-1.414 1.414L5.636 4.222zM2 12a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1z"/>
              </svg>
            </button>
          </div>
        </div>
      </header>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <section class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl p-6 shadow">
          <div class="flex items-start justify-between">
            <h3 id="pasteTitle" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Paste text</h3>
            <div id="limitText" class="text-sm text-gray-500 dark:text-gray-400">Up to 10,000 chars</div>
          </div>

          <textarea id="inputText" maxlength="10000" rows="10"
            class="w-full mt-4 p-4 rounded-lg border dark:border-gray-700 dark:bg-gray-900 text-sm"
            placeholder="Paste your text here..."></textarea>

          <div class="mt-4 flex items-center gap-3">
            <button id="checkTextBtn" class="px-5 py-2 rounded-lg bg-purple-accent text-white font-semibold hover:opacity-95">Check Text</button>

            <label id="dropZone" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-purple-accent-2/10 border border-dashed cursor-pointer text-sm text-gray-700 dark:text-gray-200 hover:bg-purple-accent-2/20">
              <input id="fileInput" type="file" accept=".pdf,.docx,.txt" class="hidden" />
              <svg class="w-5 h-5 text-purple-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V8a4 4 0 018 0v8"/>
              </svg>
              <span id="dropLabel">Drag & drop or click to upload</span>
            </label>

            <div id="uploadProgress" class="hidden w-48 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
              <div id="uploadBar" class="h-2 bg-purple-accent" style="width:0%"></div>
            </div>
          </div>

          <div class="mt-5 p-4 rounded-lg bg-gray-50 dark:bg-gray-900 border dark:border-gray-700">
            <label id="scrapeLabel" class="text-sm font-medium">Add online sources to corpus (one URL per line)</label>
            <textarea id="urlList" rows="2" class="mt-2 w-full p-2 rounded border dark:bg-gray-900 text-sm" placeholder="https://example.com/article"></textarea>
            <div class="mt-3 flex gap-3">
              <button id="scrapeBtn" class="px-4 py-2 rounded-lg bg-purple-accent text-white hover:opacity-95">Add to Corpus</button>
              <button id="rebuildSmallBtn" class="px-4 py-2 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-800">Rebuild Index</button>
            </div>
            <p id="scrapeHint" class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              Adding URLs will attempt to scrape and save articles to the corpus directory on the server.
            </p>
          </div>
        </section>

        <aside class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow space-y-4">
          <div>
            <h4 id="summaryTitle" class="text-sm font-semibold text-gray-800 dark:text-gray-100">Scan Summary</h4>
            <div id="summaryBox" class="mt-3 text-sm text-gray-600 dark:text-gray-300">No scan yet</div>
          </div>

          <div>
            <h4 id="recentTitle" class="text-sm font-semibold text-gray-800 dark:text-gray-100">Recent Scans</h4>
            <ul id="historyList" class="mt-3 space-y-2 max-h-48 overflow-auto text-sm"></ul>
          </div>

          <div>
            <h4 id="corpusTitle" class="text-sm font-semibold text-gray-800 dark:text-gray-100">Corpus Controls</h4>
            <div class="mt-2 space-y-2">
              <div class="text-xs text-gray-500 dark:text-gray-400">
                <span id="corpusCountLabel">Corpus count:</span> <span id="sidebarCorpusCount">‚Äî</span>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <!-- AI Detection Panel -->
      <section id="aiDetectionPanel" class="mt-6 bg-white dark:bg-gray-800 rounded-xl p-6 shadow hidden">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">ü§ñ AI-Generated Text Analysis</h3>
          <div id="aiBadge" class="text-sm font-semibold px-3 py-1 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">‚Äî</div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-900">
            <div class="text-xs text-gray-500 dark:text-gray-400">AI Probability</div>
            <div id="aiProbability" class="text-2xl font-bold mt-1">--%</div>
          </div>
          <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-900">
            <div class="text-xs text-gray-500 dark:text-gray-400">Confidence</div>
            <div id="aiConfidence" class="text-2xl font-bold mt-1">--</div>
          </div>
          <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-900">
            <div class="text-xs text-gray-500 dark:text-gray-400">Status</div>
            <div id="aiStatus" class="text-lg font-semibold mt-1">Analyzing...</div>
          </div>
        </div>
        <div id="aiWarning" class="mt-4 p-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 hidden ai-warning">
          <div class="flex items-center gap-2 text-red-700 dark:text-red-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <span class="font-medium">Warning:</span>
            <span id="aiWarningText">This text may be AI-generated</span>
          </div>
        </div>
      </section>

      <!-- Results Panel -->
      <section id="resultsPanel" class="mt-6 bg-white dark:bg-gray-800 rounded-xl p-6 shadow hidden">
        <div class="flex items-center justify-between">
          <h3 id="resultsTitle" class="text-lg font-semibold">Scan Results</h3>
          <div id="overallBadge" class="text-sm font-semibold px-3 py-1 rounded-lg">‚Äî</div>
        </div>

        <div id="resultsContent" class="mt-4 grid grid-cols-1 gap-4"></div>
      </section>

      <!-- Citations Panel -->
      <section id="citationsPanel" class="mt-6 bg-white dark:bg-gray-800 rounded-xl p-6 shadow hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">üìö Citations</h3>
          <div class="flex gap-2">
            <button id="apaBtn" class="px-3 py-1 rounded-lg bg-purple-accent text-white text-sm hover:opacity-95">APA</button>
            <button id="mlaBtn" class="px-3 py-1 rounded-lg bg-gray-200 dark:bg-gray-700 text-sm hover:bg-gray-300 dark:hover:bg-gray-600">MLA</button>
            <button id="copyCitationsBtn" class="px-3 py-1 rounded-lg bg-green-600 text-white text-sm hover:opacity-95">
              Copy All
            </button>
          </div>
        </div>
        <div id="citationsList" class="space-y-3 max-h-96 overflow-y-auto p-2">
          <!-- Citations will be inserted here -->
        </div>
      </section>

      <!-- Statistics Panel -->
      <section id="statsPanel" class="mt-6 bg-white dark:bg-gray-800 rounded-xl p-6 shadow hidden">
        <h3 class="text-lg font-semibold mb-4">üìä Statistics</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20">
            <div class="text-xs text-gray-500 dark:text-gray-400">Total Scans</div>
            <div id="statsTotalScans" class="text-2xl font-bold mt-1">0</div>
          </div>
          <div class="p-4 rounded-lg bg-green-50 dark:bg-green-900/20">
            <div class="text-xs text-gray-500 dark:text-gray-400">Average Score</div>
            <div id="statsAvgScore" class="text-2xl font-bold mt-1">0%</div>
          </div>
          <div class="p-4 rounded-lg bg-purple-50 dark:bg-purple-900/20">
            <div class="text-xs text-gray-500 dark:text-gray-400">Today's Scans</div>
            <div id="statsTodayScans" class="text-2xl font-bold mt-1">0</div>
          </div>
        </div>
        <div class="mt-6">
          <h4 class="text-sm font-semibold mb-2">Recent Activity</h4>
          <div id="recentActivity" class="space-y-2 max-h-48 overflow-y-auto">
            <!-- Activity items will be inserted here -->
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
    /* ====== Config ====== */
    const backendUrl = "http://127.0.0.1:5000";
    const SCORE_THRESHOLDS = { low:30, med:60 };
    const UI_LANG_KEY = "ui_lang";
    window.__lastResult = null;
    let currentUser = localStorage.getItem('current_user') || 'anonymous';

    /* ====== i18n strings (English/Arabic) ====== */
    const STR = {
      en: {
        home: "Home",
        checker: "Open Checker",
        subtitle: "AI Plagiarism Dashboard",
        pageTitle: "Scan ¬∑ New",
        pageHint: "Paste text or upload a document to detect plagiarism",
        langLabel: "Language (we'll translate)",
        pasteTitle: "Paste text",
        limit: "Up to 10,000 chars",
        check: "Check Text",
        drop: "Drag & drop or click to upload",
        scrapeLabel: "Add online sources to corpus (one URL per line)",
        addCorpus: "Add to Corpus",
        rebuild: "Rebuild Index",
        scrapeHint: "Adding URLs will attempt to scrape and save articles to the corpus directory on the server.",
        summary: "Scan Summary",
        noScan: "No scan yet",
        recent: "Recent Scans",
        corpusControls: "Corpus Controls",
        corpusSize: "Corpus size:",
        corpusCount: "Corpus count:",
        results: "Scan Results",
        chunk: (n)=>`Chunk ${n}`,
        noMatches: "No strong matches found for this chunk.",
        translated: (lang)=>`Text was translated to EN before analysis (detected/requested: ${lang}).`,
        analyzing: "Analyzing text‚Ä¶",
        uploading: "Uploading file & scanning...",
        scraping: "Scraping sources...",
        rebuilding: "Rebuilding index...",
        aiWarning: "This text shows signs of AI generation",
        batchUpload: "Upload Multiple Files",
        generatingCitations: "Generating citations..."
      },
      ar: {
        home: "ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
        checker: "ŸÅÿ™ÿ≠ ÿßŸÑŸÅÿßÿ≠ÿµ",
        subtitle: "ŸÑŸàÿ≠ÿ© ŸÉÿ¥ŸÅ ÿßŸÑÿßŸÜÿ™ÿ≠ÿßŸÑ",
        pageTitle: "ŸÅÿ≠ÿµ ¬∑ ÿ¨ÿØŸäÿØ",
        pageHint: "ÿ£ŸÑÿµŸÇ ÿßŸÑŸÜÿµ ÿ£Ÿà ÿßÿ±ŸÅÿπ ŸÖŸÑŸÅŸãÿß ŸÑŸÑŸÉÿ¥ŸÅ ÿπŸÜ ÿßŸÑÿßŸÜÿ™ÿ≠ÿßŸÑ",
        langLabel: "ŸÑÿ∫ÿ© ÿßŸÑŸÜÿµ (ÿ≥ŸÜÿ™ÿ±ÿ¨ŸÖ)",
        pasteTitle: "ÿ£ŸÑÿµŸÇ ÿßŸÑŸÜÿµ",
        limit: "ÿ≠ÿ™Ÿâ Ÿ°Ÿ†Ÿ¨Ÿ†Ÿ†Ÿ† ÿ≠ÿ±ŸÅ",
        check: "ŸÅÿ≠ÿµ ÿßŸÑŸÜÿµ",
        drop: "ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ",
        scrapeLabel: "ÿ£ÿ∂ŸÅ ŸÖÿµÿßÿØÿ± ŸÖŸÜ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ (ÿ±ÿßÿ®ÿ∑ ŸÅŸä ŸÉŸÑ ÿ≥ÿ∑ÿ±)",
        addCorpus: "ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖÿ≥ÿ™ŸàÿØÿπ",
        rebuild: "ÿ•ÿπÿßÿØÿ© ÿ®ŸÜÿßÿ° ÿßŸÑŸÅŸáÿ±ÿ≥",
        scrapeHint: "ÿ≥Ÿäÿ™ŸÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµ Ÿàÿ≠ŸÅÿ∏Ÿá ÿØÿßÿÆŸÑ ŸÖÿ¨ŸÑÿØ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ.",
        summary: "ŸÖŸÑÿÆÿµ ÿßŸÑŸÅÿ≠ÿµ",
        noScan: "ŸÑÿß ŸäŸàÿ¨ÿØ ŸÅÿ≠ÿµ ÿ®ÿπÿØ",
        recent: "ÿßŸÑŸÅÿ≠Ÿàÿµÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©",
        corpusControls: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ",
        corpusSize: "ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ:",
        corpusCount: "ÿπÿØÿØ ÿßŸÑŸÖŸÇÿßÿ∑ÿπ:",
        results: "ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÅÿ≠ÿµ",
        chunk: (n)=>`ÿßŸÑŸÖŸÇÿ∑ÿπ ${n}`,
        noMatches: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ∑ÿßÿ®ŸÇÿßÿ™ ŸÇŸàŸäÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÇÿ∑ÿπ.",
        translated: (lang)=>`ÿ™ŸÖÿ™ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ© ÿ•ŸÑŸâ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ (ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅÿ©/ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©: ${lang}).`,
        analyzing: "ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿµ‚Ä¶",
        uploading: "ÿ¨ÿßÿ±Ÿç ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ŸàŸÅÿ≠ÿµŸá...",
        scraping: "ÿ¨ÿßÿ±Ÿç ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÖÿµÿßÿØÿ±...",
        rebuilding: "ÿ¨ÿßÿ±Ÿç ÿ•ÿπÿßÿØÿ© ÿ®ŸÜÿßÿ° ÿßŸÑŸÅŸáÿ±ÿ≥...",
        aiWarning: "Ÿäÿ®ÿØŸà ÿ£ŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÜÿµ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä",
        batchUpload: "ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©",
        generatingCitations: "ÿ¨ÿßÿ±Ÿç ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ±ÿßÿ¨ÿπ..."
      }
    };

    function getUILang() {
      return localStorage.getItem(UI_LANG_KEY) || "en";
    }
    function setUILang(lang) {
      localStorage.setItem(UI_LANG_KEY, lang);
    }
    function applyLangUI() {
      const lang = getUILang();
      const s = STR[lang];

      document.documentElement.lang = (lang === "ar") ? "ar" : "en";
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";

      document.getElementById("navHome").textContent = s.home;
      document.getElementById("navChecker").textContent = s.checker;
      document.getElementById("subTitle").textContent = s.subtitle;
      document.getElementById("sideSub").textContent = s.subtitle;

      document.getElementById("pageTitle").textContent = s.pageTitle;
      document.getElementById("pageHint").textContent = s.pageHint;
      document.getElementById("langLabel").textContent = s.langLabel;
      document.getElementById("pasteTitle").textContent = s.pasteTitle;
      document.getElementById("limitText").textContent = s.limit;
      document.getElementById("checkTextBtn").textContent = s.check;
      document.getElementById("dropLabel").textContent = s.drop;

      document.getElementById("scrapeLabel").textContent = s.scrapeLabel;
      document.getElementById("scrapeBtn").textContent = s.addCorpus;
      document.getElementById("rebuildSmallBtn").textContent = s.rebuild;
      document.getElementById("rebuildBtn").textContent = s.rebuild;
      document.getElementById("scrapeHint").textContent = s.scrapeHint;

      document.getElementById("summaryTitle").textContent = s.summary;
      document.getElementById("recentTitle").textContent = s.recent;
      document.getElementById("corpusTitle").textContent = s.corpusControls;
      document.getElementById("corpusSizeLabel").textContent = s.corpusSize;
      document.getElementById("corpusCountLabel").textContent = s.corpusCount;
      document.getElementById("resultsTitle").textContent = s.results;

      const toggle = document.getElementById("uiLangToggle");
      toggle.textContent = (lang === "ar") ? "EN" : "AR";

      if (!window.__lastResult) summaryBox.textContent = s.noScan;
    }

    /* ====== Theme Toggle FIXED ====== */
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      if (isDark) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        document.getElementById('sunIcon').classList.add('hidden');
        document.getElementById('moonIcon').classList.remove('hidden');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        document.getElementById('sunIcon').classList.remove('hidden');
        document.getElementById('moonIcon').classList.add('hidden');
      }
    }

    function toggleTheme() {
      const isDark = document.documentElement.classList.contains('dark');
      
      if (isDark) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        document.getElementById('sunIcon').classList.remove('hidden');
        document.getElementById('moonIcon').classList.add('hidden');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        document.getElementById('sunIcon').classList.add('hidden');
        document.getElementById('moonIcon').classList.remove('hidden');
      }
    }

    /* ====== DOM refs ====== */
    const inputText = document.getElementById('inputText');
    const checkTextBtn = document.getElementById('checkTextBtn');
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const dropLabel = document.getElementById('dropLabel');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBar = document.getElementById('uploadBar');
    const resultsPanel = document.getElementById('resultsPanel');
    const resultsContent = document.getElementById('resultsContent');
    const overallBadge = document.getElementById('overallBadge');
    const summaryBox = document.getElementById('summaryBox');
    const historyList = document.getElementById('historyList');
    const corpusCount = document.getElementById('corpusCount');
    const sidebarCorpusCount = document.getElementById('sidebarCorpusCount');
    const urlList = document.getElementById('urlList');
    const scrapeBtn = document.getElementById('scrapeBtn');
    const rebuildBtn = document.getElementById('rebuildBtn');
    const rebuildSmallBtn = document.getElementById('rebuildSmallBtn');
    const themeToggle = document.getElementById('themeToggle');
    const batchFileInput = document.getElementById('batchFileInput');
    const batchProgress = document.getElementById('batchProgress');
    const batchProgressBar = document.getElementById('batchProgressBar');
    const batchStatus = document.getElementById('batchStatus');
    const aiDetectionPanel = document.getElementById('aiDetectionPanel');
    const aiProbability = document.getElementById('aiProbability');
    const aiConfidence = document.getElementById('aiConfidence');
    const aiStatus = document.getElementById('aiStatus');
    const aiWarning = document.getElementById('aiWarning');
    const aiWarningText = document.getElementById('aiWarningText');
    const aiBadge = document.getElementById('aiBadge');
    const citationsPanel = document.getElementById('citationsPanel');
    const citationsList = document.getElementById('citationsList');
    const apaBtn = document.getElementById('apaBtn');
    const mlaBtn = document.getElementById('mlaBtn');
    const copyCitationsBtn = document.getElementById('copyCitationsBtn');
    const statsPanel = document.getElementById('statsPanel');
    const statsTotalScans = document.getElementById('statsTotalScans');
    const statsAvgScore = document.getElementById('statsAvgScore');
    const statsTodayScans = document.getElementById('statsTodayScans');
    const recentActivity = document.getElementById('recentActivity');
    const totalScansBadge = document.getElementById('totalScans');

    /* ====== Theme toggle ====== */
    themeToggle.addEventListener('click', toggleTheme);
    initTheme(); // Initialize theme on load

    /* ====== Arabic toggle ====== */
    document.getElementById("uiLangToggle").addEventListener("click", () => {
      const next = (getUILang() === "en") ? "ar" : "en";
      setUILang(next);
      applyLangUI();
    });

    /* ====== Navigation ====== */
    document.getElementById('nav_scan').addEventListener('click', () => {
      showPanel('scan');
    });
    document.getElementById('nav_history').addEventListener('click', async () => {
      await showPanel('history');
      loadHistoryFromServer();
    });
    document.getElementById('nav_stats').addEventListener('click', async () => {
      await showPanel('stats');
      loadStats();
    });

    function showPanel(panelName) {
      // Hide all panels
      document.querySelectorAll('section[id$="Panel"]').forEach(panel => {
        panel.classList.add('hidden');
      });
      
      // Show selected panel
      if (panelName === 'scan') {
        // Show main content (already visible)
      } else if (panelName === 'history') {
        // History is loaded via API
      } else if (panelName === 'stats') {
        statsPanel.classList.remove('hidden');
      }
    }

    /* ====== Local history ====== */
    function loadHistory() {
      const h = JSON.parse(localStorage.getItem('scan_history') || '[]');
      renderHistory(h);
    }
    function saveToHistory(item) {
      const h = JSON.parse(localStorage.getItem('scan_history') || '[]');
      h.unshift(item);
      if (h.length > 25) h.pop();
      localStorage.setItem('scan_history', JSON.stringify(h));
      renderHistory(h);
    }
    function renderHistory(h) {
      const s = STR[getUILang()];
      historyList.innerHTML = '';
      if (!h.length) {
        historyList.innerHTML = `<li class="text-xs text-gray-400">${escapeHtml(s.noScan)}</li>`;
        return;
      }
      h.forEach((it) => {
        const li = document.createElement('li');
        li.innerHTML = `<button class="w-full text-left text-sm px-2 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">${escapeHtml(it.label)} ¬∑ <span class="text-xs text-gray-500">${escapeHtml(it.date)}</span></button>`;
        li.querySelector('button').addEventListener('click', ()=> {
          window.__lastResult = it.data;
          renderResults(it.data);
        });
        historyList.appendChild(li);
      });
    }

    /* ====== Server history ====== */
    async function loadHistoryFromServer() {
      try {
        const res = await fetch(`${backendUrl}/get-history?limit=20`);
        const data = await res.json();
        if (data.history) {
          renderServerHistory(data.history);
        }
      } catch (error) {
        console.error('Failed to load server history:', error);
      }
    }

    function renderServerHistory(history) {
      const s = STR[getUILang()];
      historyList.innerHTML = '';
      if (!history.length) {
        historyList.innerHTML = `<li class="text-xs text-gray-400">${escapeHtml(s.noScan)}</li>`;
        return;
      }
      history.forEach((item) => {
        const li = document.createElement('li');
        const date = new Date(item.scan_date).toLocaleString();
        li.innerHTML = `
          <button class="w-full text-left text-sm px-2 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
            <div class="font-medium">${escapeHtml(item.filename)}</div>
            <div class="text-xs text-gray-500 flex justify-between">
              <span>${escapeHtml(date)}</span>
              <span class="font-semibold ${item.overall_score > 50 ? 'text-red-600' : item.overall_score > 20 ? 'text-yellow-600' : 'text-green-600'}">
                ${item.overall_score}%
              </span>
            </div>
          </button>
        `;
        historyList.appendChild(li);
      });
    }

    /* ====== Statistics ====== */
    async function loadStats() {
      try {
        const res = await fetch(`${backendUrl}/stats`);
        const data = await res.json();
        
        if (data.error) throw new Error(data.error);
        
        statsTotalScans.textContent = data.total_scans || 0;
        statsAvgScore.textContent = `${data.average_score || 0}%`;
        statsTodayScans.textContent = data.today_scans || 0;
        totalScansBadge.textContent = `${data.total_scans || 0} scans`;
        totalScansBadge.parentElement.classList.remove('hidden');
        
        // Load recent activity
        await loadRecentActivity();
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    async function loadRecentActivity() {
      try {
        const res = await fetch(`${backendUrl}/get-history?limit=10`);
        const data = await res.json();
        
        if (data.history) {
          recentActivity.innerHTML = '';
          data.history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'p-2 rounded-lg bg-gray-50 dark:bg-gray-900 text-sm';
            div.innerHTML = `
              <div class="flex justify-between">
                <span class="font-medium truncate">${escapeHtml(item.filename)}</span>
                <span class="font-semibold ${item.overall_score > 50 ? 'text-red-600' : item.overall_score > 20 ? 'text-yellow-600' : 'text-green-600'}">
                  ${item.overall_score}%
                </span>
              </div>
              <div class="text-xs text-gray-500 mt-1">
                ${new Date(item.scan_date).toLocaleString()}
              </div>
            `;
            recentActivity.appendChild(div);
          });
        }
      } catch (error) {
        console.error('Failed to load recent activity:', error);
      }
    }

    /* ====== corpus count ====== */
    async function fetchCorpusCount() {
      try {
        const res = await fetch(`${backendUrl}/corpus-info`);
        const j = await res.json();
        const count = j.corpus_size ?? 0;
        corpusCount.textContent = `${count} chunks`;
        sidebarCorpusCount.textContent = `${count}`;
      } catch(e) {
        corpusCount.textContent = '‚Äî';
        sidebarCorpusCount.textContent = '‚Äî';
      }
    }

    /* ====== loading UI ====== */
    function setLoading(on, label) {
      const s = STR[getUILang()];
      const msg = label || s.analyzing;
      if (on) {
        checkTextBtn.disabled = true;
        uploadProgress.classList.add('hidden');
        resultsPanel.classList.add('hidden');
        aiDetectionPanel.classList.add('hidden');
        citationsPanel.classList.add('hidden');
        summaryBox.innerHTML = `<div class="text-sm text-gray-500">${escapeHtml(msg)}</div>`;
      } else {
        checkTextBtn.disabled = false;
      }
    }

    /* ====== check text ====== */
    async function checkText() {
      const s = STR[getUILang()];
      const text = inputText.value.trim();
      const language = document.getElementById('languageSelect').value;
      if (!text) return alert('Please paste some text to scan.');

      setLoading(true, s.analyzing);

      try {
        const res = await fetch(`${backendUrl}/check-text`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, language })
        });
        const j = await res.json();
        if (j.error) {
          setLoading(false);
          alert(j.error);
          return;
        }
        setLoading(false);
        window.__lastResult = j;
        renderResults(j);
        saveToHistory({ label: 'Text scan', date: new Date().toLocaleString(), data: j });
        await loadStats(); // Refresh stats
      } catch (err) {
        setLoading(false);
        alert('Could not reach backend. Is the server running?');
        console.error(err);
      }
    }

    /* ====== upload with progress ====== */
    function uploadFileWithProgress(file, language) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const fd = new FormData();
        fd.append('file', file);
        fd.append('language', language || 'auto');

        xhr.open('POST', `${backendUrl}/check-file`, true);

        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            uploadProgress.classList.remove('hidden');
            uploadBar.style.width = pct + '%';
          }
        };

        xhr.onload = function() {
          uploadProgress.classList.add('hidden');
          uploadBar.style.width = '0%';
          if (xhr.status >= 200 && xhr.status < 300) {
            try { resolve(JSON.parse(xhr.responseText)); }
            catch(e) { reject(e); }
          } else {
            reject(new Error('Upload failed: ' + xhr.status));
          }
        };

        xhr.onerror = function() { uploadProgress.classList.add('hidden'); reject(new Error('Network error')); };
        xhr.send(fd);
      });
    }

    async function handleFileUpload(file) {
      const s = STR[getUILang()];
      setLoading(true, s.uploading);
      try {
        const language = document.getElementById('languageSelect').value;
        const result = await uploadFileWithProgress(file, language);
        if (result.error) {
          setLoading(false);
          alert(result.error);
          return;
        }
        setLoading(false);
        window.__lastResult = result;
        renderResults(result);
        saveToHistory({ label: `File: ${file.name}`, date: new Date().toLocaleString(), data: result });
        await loadStats(); // Refresh stats
      } catch(e) {
        setLoading(false);
        alert('Upload or scan failed: ' + (e.message || e));
        console.error(e);
      }
    }

    /* ====== FIXED batch upload ====== */
    batchFileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      
      const s = STR[getUILang()];
      batchProgress.classList.remove('hidden');
      batchStatus.textContent = `Processing ${files.length} files...`;
      
      let completed = 0;
      const results = [];
      
      for (const file of files) {
        try {
          batchStatus.textContent = `Processing ${file.name}...`;
          batchProgressBar.style.width = `${(completed / files.length) * 100}%`;
          
          // Use the single file upload endpoint for each file
          const language = document.getElementById('languageSelect').value;
          const formData = new FormData();
          formData.append('file', file);
          formData.append('language', language || 'auto');
          
          const res = await fetch(`${backendUrl}/check-file`, {
            method: 'POST',
            body: formData
          });
          
          if (res.ok) {
            const result = await res.json();
            results.push({ filename: file.name, ...result });
            completed++;
            batchProgressBar.style.width = `${(completed / files.length) * 100}%`;
          }
        } catch (error) {
          console.error(`Failed to process ${file.name}:`, error);
        }
      }
      
      batchStatus.textContent = `Completed ${completed}/${files.length} files`;
      
      // Show results for each file
      if (results.length > 0) {
        // Clear previous results
        resultsPanel.classList.remove('hidden');
        resultsContent.innerHTML = '';
        
        // Display each file's results
        results.forEach((result, index) => {
          const card = document.createElement('div');
          card.className = 'p-4 rounded-lg border dark:border-gray-700 bg-gray-50 dark:bg-gray-900 mb-4';
          
          card.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <div class="font-medium text-sm">${escapeHtml(result.filename)}</div>
              <div class="text-sm font-semibold ${result.overall_score > 50 ? 'text-red-600' : result.overall_score > 20 ? 'text-yellow-600' : 'text-green-600'}">
                ${result.overall_score}%
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-2">${escapeHtml(result.message || '')}</div>
            <div class="text-xs">
              <span class="font-medium">Chunks:</span> ${result.total_chunks || 0} | 
              <span class="font-medium">AI Probability:</span> ${result.ai_analysis?.ai_probability || 0}%
            </div>
            <button class="mt-2 text-xs text-purple-accent hover:underline view-details-btn" data-index="${index}">
              View Details
            </button>
            <div class="file-details hidden mt-3" id="details-${index}"></div>
          `;
          
          resultsContent.appendChild(card);
        });
        
        // Add event listeners for view details buttons
        document.querySelectorAll('.view-details-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            const detailsDiv = document.getElementById(`details-${index}`);
            const isHidden = detailsDiv.classList.contains('hidden');
            
            // Hide all other details
            document.querySelectorAll('.file-details').forEach(d => {
              d.classList.add('hidden');
            });
            
            if (isHidden) {
              detailsDiv.classList.remove('hidden');
              this.textContent = 'Hide Details';
              
              // Show detailed results for this file
              const result = results[index];
              let detailsHtml = '<div class="text-xs space-y-2">';
              
              if (result.details && result.details.length > 0) {
                result.details.forEach((detail, idx) => {
                  detailsHtml += `
                    <div class="p-2 bg-white dark:bg-gray-800 rounded">
                      <div class="font-medium">Chunk ${idx + 1} (${(detail.best_similarity * 100).toFixed(2)}%)</div>
                      <div class="text-gray-600 dark:text-gray-300 truncate">${escapeHtml(detail.chunk_text?.substring(0, 100) || '')}...</div>
                    </div>
                  `;
                });
              }
              detailsHtml += '</div>';
              detailsDiv.innerHTML = detailsHtml;
            } else {
              detailsDiv.classList.add('hidden');
              this.textContent = 'View Details';
            }
          });
        });
        
        // Update overall badge
        const avgScore = results.reduce((sum, r) => sum + r.overall_score, 0) / results.length;
        overallBadge.textContent = `Batch: ${avgScore.toFixed(2)}% average`;
        overallBadge.className = `text-sm font-semibold px-3 py-1 rounded-lg ${
          avgScore > 50 ? 'text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300' :
          avgScore > 20 ? 'text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20 dark:text-yellow-300' :
          'text-green-600 bg-green-50 dark:bg-green-900/20 dark:text-green-300'
        }`;
      }
      
      setTimeout(() => {
        batchProgress.classList.add('hidden');
        batchProgressBar.style.width = '0%';
      }, 2000);
    });

    /* ====== dropzone ====== */
    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('dragover', (e)=> { e.preventDefault(); dropZone.classList.add('ring-2','ring-purple-accent/30'); });
    dropZone.addEventListener('dragleave', ()=> { dropZone.classList.remove('ring-2','ring-purple-accent/30'); });
    dropZone.addEventListener('drop', async (e)=> {
      e.preventDefault();
      dropZone.classList.remove('ring-2','ring-purple-accent/30');
      const f = e.dataTransfer.files[0];
      if (!f) return;
      dropLabel.textContent = f.name;
      await handleFileUpload(f);
    });
    fileInput.addEventListener('change', async ()=> {
      const f = fileInput.files[0];
      if (!f) return;
      dropLabel.textContent = f.name;
      await handleFileUpload(f);
    });

    /* ====== highlight renderer ====== */
    function renderWithHighlights(text, spans) {
      if (!text) return '';
      if (!spans || !spans.length) return escapeHtml(text);

      let out = '';
      let last = 0;

      const safeSpans = spans
        .filter(sp => typeof sp.start === 'number' && typeof sp.end === 'number')
        .map(sp => ({ start: Math.max(0, Math.min(text.length, sp.start)), end: Math.max(0, Math.min(text.length, sp.end)) }))
        .filter(sp => sp.end > sp.start)
        .sort((a,b)=>a.start-b.start);

      for (const sp of safeSpans) {
        if (sp.start > last) out += escapeHtml(text.slice(last, sp.start));
        out += `<mark class="plag-mark">${escapeHtml(text.slice(sp.start, sp.end))}</mark>`;
        last = sp.end;
      }
      if (last < text.length) out += escapeHtml(text.slice(last));
      return out;
    }

    /* ====== render results ====== */
    function renderResults(data) {
      const s = STR[getUILang()];
      resultsPanel.classList.remove('hidden');
      resultsContent.innerHTML = '';

      const score = data.overall_score ?? 0;
      let colorClass = 'text-green-600 bg-green-50 dark:bg-green-900/20 dark:text-green-300';
      if (score > SCORE_THRESHOLDS.med) colorClass = 'text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300';
      else if (score > SCORE_THRESHOLDS.low) colorClass = 'text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20 dark:text-yellow-300';

      overallBadge.className = `text-sm font-semibold px-3 py-1 rounded-lg ${colorClass}`;
      overallBadge.textContent = `${score}% ‚Äî ${data.message || ''}`;

      // Show AI Detection
      if (data.ai_analysis) {
        aiDetectionPanel.classList.remove('hidden');
        aiProbability.textContent = `${data.ai_analysis.ai_probability}%`;
        aiConfidence.textContent = data.ai_analysis.confidence;
        aiStatus.textContent = data.ai_analysis.is_ai_generated ? 'AI Detected' : 'Human-like';
        
        if (data.ai_analysis.is_ai_generated) {
          aiWarning.classList.remove('hidden');
          aiWarningText.textContent = s.aiWarning;
          aiBadge.textContent = 'AI Detected';
          aiBadge.className = 'text-sm font-semibold px-3 py-1 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
        } else {
          aiWarning.classList.add('hidden');
          aiBadge.textContent = 'Human-like';
          aiBadge.className = 'text-sm font-semibold px-3 py-1 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
        }
      }

      const usedTranslation = !!data.used_translation;
      const detected = data.detected_language || data.requested_language || 'auto';

      summaryBox.innerHTML = `
        <div class="text-sm font-medium">${escapeHtml(s.summary)}</div>
        <div class="text-xs text-gray-500">${escapeHtml(data.message || '')}</div>
        ${usedTranslation ? `<div class="mt-1 text-xs text-purple-700 dark:text-purple-300">${escapeHtml(s.translated(detected))}</div>` : ''}
      `;

      // Collect all matches for citations
      const allMatches = [];
      const details = data.details || [];
      details.forEach((d, idx) => {
        const sim = (d.best_similarity ?? 0) * 100;

        let heatClass = 'heat-0';
        if (sim > 60) heatClass = 'heat-2';
        else if (sim > 30) heatClass = 'heat-1';

        const card = document.createElement('div');
        card.className = 'p-4 rounded-lg border dark:border-gray-700 bg-gray-50 dark:bg-gray-900';

        const chunkHtml = renderWithHighlights(d.chunk_text || '', d.highlights || []);

        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${escapeHtml(s.chunk(idx+1))}</div>
            <div class="text-sm font-semibold">${sim.toFixed(2)}%</div>
          </div>
          <div class="mt-2 text-sm whitespace-pre-wrap">${chunkHtml}</div>
        `;

        if (d.matches && d.matches.length) {
          allMatches.push(...d.matches);
          const ul = document.createElement('ul');
          ul.className = 'mt-3 text-xs list-disc ml-5';

          d.matches.slice(0,3).forEach(m => {
            const li = document.createElement('li');

            const sourceLabel = m.title || m.url || m.source || 'source';
            const safeLabel = escapeHtml(sourceLabel);
            const safeUrl = m.url ? escapeHtml(m.url) : null;
            const snippet = escapeHtml((m.matched_text || '').slice(0,120)) + '...';
            const simPct = ((m.similarity || 0) * 100).toFixed(2);

            li.innerHTML = safeUrl
              ? `<strong><a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="text-purple-accent hover:underline">${safeLabel}</a></strong>
                 ‚Äî ${simPct}%<br><em class="text-xs text-gray-500">${snippet}</em>`
              : `<strong>${safeLabel}</strong> ‚Äî ${simPct}%<br><em class="text-xs text-gray-500">${snippet}</em>`;

            ul.appendChild(li);
          });
          card.appendChild(ul);
        } else {
          const p = document.createElement('p');
          p.className = 'mt-3 text-xs text-gray-500';
          p.textContent = s.noMatches;
          card.appendChild(p);
        }

        const heat = document.createElement('div');
        heat.className = `mt-3 h-2 rounded-full ${heatClass}`;
        heat.style.width = Math.min(100, Math.max(6, sim)) + '%';
        card.appendChild(heat);

        resultsContent.appendChild(card);
      });

      // Generate citations if there are matches
      if (allMatches.length > 0) {
        generateCitations(allMatches, 'apa');
      } else {
        citationsPanel.classList.add('hidden');
      }

      resultsPanel.scrollIntoView({ behavior: 'smooth' });
    }

    /* ====== citations ====== */
    async function generateCitations(matches, style = 'apa') {
      const s = STR[getUILang()];
      citationsPanel.classList.remove('hidden');
      citationsList.innerHTML = '<div class="text-center text-gray-500">Generating citations...</div>';
      
      try {
        const res = await fetch(`${backendUrl}/generate-citations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ matches, style })
        });
        const data = await res.json();
        
        if (data.citations && data.citations.length > 0) {
          citationsList.innerHTML = '';
          data.citations.forEach((cite, index) => {
            const div = document.createElement('div');
            div.className = 'p-3 rounded-lg bg-gray-50 dark:bg-gray-900 border dark:border-gray-700';
            div.innerHTML = `
              <div class="text-sm">${escapeHtml(cite.text)}</div>
              <div class="mt-2 flex justify-between text-xs">
                <span class="text-gray-500">Similarity: ${((cite.similarity || 0) * 100).toFixed(2)}%</span>
                <a href="${escapeHtml(cite.url)}" target="_blank" class="text-purple-accent hover:underline">View Source</a>
              </div>
            `;
            citationsList.appendChild(div);
          });
        } else {
          citationsList.innerHTML = '<div class="text-center text-gray-500">No citations generated</div>';
        }
      } catch (error) {
        console.error('Failed to generate citations:', error);
        citationsList.innerHTML = '<div class="text-center text-red-500">Failed to generate citations</div>';
      }
    }

    // Citation style buttons
    apaBtn.addEventListener('click', () => {
      apaBtn.className = 'px-3 py-1 rounded-lg bg-purple-accent text-white text-sm hover:opacity-95';
      mlaBtn.className = 'px-3 py-1 rounded-lg bg-gray-200 dark:bg-gray-700 text-sm hover:bg-gray-300 dark:hover:bg-gray-600';
      if (window.__lastResult) {
        const allMatches = [];
        window.__lastResult.details?.forEach(d => {
          if (d.matches) allMatches.push(...d.matches);
        });
        generateCitations(allMatches, 'apa');
      }
    });

    mlaBtn.addEventListener('click', () => {
      mlaBtn.className = 'px-3 py-1 rounded-lg bg-purple-accent text-white text-sm hover:opacity-95';
      apaBtn.className = 'px-3 py-1 rounded-lg bg-gray-200 dark:bg-gray-700 text-sm hover:bg-gray-300 dark:hover:bg-gray-600';
      if (window.__lastResult) {
        const allMatches = [];
        window.__lastResult.details?.forEach(d => {
          if (d.matches) allMatches.push(...d.matches);
        });
        generateCitations(allMatches, 'mla');
      }
    });

    // Copy citations button
    copyCitationsBtn.addEventListener('click', () => {
      const citations = Array.from(citationsList.querySelectorAll('div.text-sm'))
        .map(div => div.textContent)
        .join('\n\n');
      
      navigator.clipboard.writeText(citations)
        .then(() => {
          const originalText = copyCitationsBtn.textContent;
          copyCitationsBtn.textContent = 'Copied!';
          copyCitationsBtn.className = 'px-3 py-1 rounded-lg bg-green-600 text-white text-sm';
          setTimeout(() => {
            copyCitationsBtn.textContent = originalText;
            copyCitationsBtn.className = 'px-3 py-1 rounded-lg bg-green-600 text-white text-sm hover:opacity-95';
          }, 2000);
        })
        .catch(err => {
          console.error('Failed to copy:', err);
          alert('Failed to copy citations to clipboard');
        });
    });

    /* ====== scrape + rebuild ====== */
    scrapeBtn.addEventListener('click', async () => {
      const s = STR[getUILang()];
      const raw = urlList.value.trim();
      if (!raw) return alert('Enter at least one URL (newline separated).');
      const urls = raw.split(/\n+/).map(u=>u.trim()).filter(Boolean);

      setLoading(true, s.scraping);
      try {
        const res = await fetch(`${backendUrl}/scrape`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });
        const j = await res.json();
        if (j.error) { setLoading(false); alert(j.error); return; }
        setLoading(false);
        alert(`Saved ${j.saved_count || 0} documents to corpus.`);
        await rebuildIndex();
      } catch(e) {
        setLoading(false);
        alert('Scrape failed. See console.');
        console.error(e);
      }
    });

    async function rebuildIndex() {
      const s = STR[getUILang()];
      try {
        setLoading(true, s.rebuilding);
        const res = await fetch(`${backendUrl}/rebuild-index`, { method: 'POST' });
        const j = await res.json();
        setLoading(false);
        corpusCount.textContent = `${j.corpus_count ?? 0} chunks`;
        sidebarCorpusCount.textContent = `${j.corpus_count ?? 0}`;
        alert('Index rebuilt. Corpus size: ' + (j.corpus_count || 0));
      } catch(e) {
        setLoading(false);
        alert('Rebuild failed.');
        console.error(e);
      }
    }

    /* ====== Event Listeners ====== */
    rebuildBtn.addEventListener('click', rebuildIndex);
    rebuildSmallBtn.addEventListener('click', rebuildIndex);
    checkTextBtn.addEventListener('click', checkText);

    function escapeHtml(s='') {
      return (''+s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }

    // Initialization
    loadHistory();
    fetchCorpusCount();
    applyLangUI();
    loadStats(); // Load initial stats
    initTheme(); // Initialize theme
  </script>
</body>
</html>













































