<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PlagAware — Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'purple-accent': '#7C3AED',
            'purple-accent-2': '#C084FC',
          },
          fontFamily: { sans: ['Inter','sans-serif'] }
        }
      }
    }
  </script>

  <style>
    .heat-0 { background: linear-gradient(90deg,#ecfccb,#86efac); }
    .heat-1 { background: linear-gradient(90deg,#fef9c3,#facc15); }
    .heat-2 { background: linear-gradient(90deg,#fee2e2,#f43f5e); }
  </style>
</head>

<body class="min-h-screen bg-gray-50 text-gray-900 font-sans">

  <!-- NAV -->
  <nav class="bg-white border-b border-gray-200 sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-purple-accent text-white flex items-center justify-center font-bold text-lg">AI</div>
        <div>
          <div id="appName" class="font-extrabold text-lg">PlagAware</div>
          <div id="appTagline" class="text-xs text-gray-500">AI Plagiarism Dashboard</div>
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        <a id="homeLink" href="index.html" class="px-3 py-1 rounded-lg hover:bg-gray-100">Home</a>
        <button id="uiLangToggle" class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-50">AR</button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="max-w-6xl mx-auto px-4 pt-6">
    <div class="rounded-2xl p-6 md:p-8 shadow bg-gradient-to-r from-purple-600 via-fuchsia-600 to-pink-500 text-white">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div>
          <h1 id="heroTitle" class="text-2xl md:text-3xl font-extrabold">Plagiarism Detection (Multilingual + AI)</h1>
          <p id="heroDesc" class="mt-2 text-sm text-white/90 max-w-2xl">
            Paste text or upload files. We translate to English (if needed) and detect semantic plagiarism using embeddings + FAISS.
          </p>
        </div>

        <div class="grid grid-cols-3 gap-3 text-xs">
          <div class="bg-white/15 rounded-xl p-3">
            <div id="card1Title" class="font-bold">Upload</div>
            <div id="card1Desc" class="opacity-90">PDF / DOCX / TXT</div>
          </div>
          <div class="bg-white/15 rounded-xl p-3">
            <div id="card2Title" class="font-bold">Sources</div>
            <div id="card2Desc" class="opacity-90">URL + Title</div>
          </div>
          <div class="bg-white/15 rounded-xl p-3">
            <div id="card3Title" class="font-bold">Highlight</div>
            <div id="card3Desc" class="opacity-90">Matched spans</div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <div class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- INPUT -->
    <section class="lg:col-span-2 bg-white rounded-xl p-6 shadow">
      <div class="flex items-start justify-between">
        <h3 id="pasteTitle" class="text-lg font-semibold text-gray-800">Paste text</h3>
        <div id="limitText" class="text-sm text-gray-500">Up to 10,000 chars</div>
      </div>

      <textarea id="inputText" maxlength="10000" rows="10"
        class="w-full mt-4 p-4 rounded-lg border border-gray-200 text-sm"
        placeholder="Paste your text here..."></textarea>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <button id="checkTextBtn" class="px-5 py-2 rounded-lg bg-purple-accent text-white font-semibold hover:opacity-95">Check Text</button>

        <div class="flex items-center space-x-2 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">
          <label id="langLabel" class="text-xs text-gray-500 mr-2">Language</label>
          <select id="languageSelect" class="text-sm bg-transparent outline-none">
            <option value="auto">Detect</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="hi">Hindi</option>
            <option value="zh-cn">Chinese (Simplified)</option>
            <option value="ar">Arabic</option>
            <option value="ru">Russian</option>
          </select>
        </div>

        <label id="dropZone" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-purple-accent-2/10 border border-dashed cursor-pointer text-sm text-gray-700">
          <input id="fileInput" type="file" accept=".pdf,.docx,.txt" class="hidden" />
          <span id="dropLabel">Drag & drop or click to upload</span>
        </label>

        <div id="uploadProgress" class="hidden w-48 bg-gray-100 rounded-full overflow-hidden">
          <div id="uploadBar" class="h-2 bg-purple-accent" style="width:0%"></div>
        </div>
      </div>

      <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-indigo-50 via-purple-50 to-pink-50 border border-purple-100">
        <label id="scrapeLabel" class="text-sm font-semibold text-gray-700">Add online sources to corpus (one URL per line)</label>
        <textarea id="urlList" rows="2"
          class="mt-2 w-full p-2 rounded border border-gray-200 bg-white text-sm"
          placeholder="https://en.wikipedia.org/wiki/Plagiarism"></textarea>
        <div class="mt-3 flex gap-3">
          <button id="scrapeBtn" class="px-4 py-2 rounded-lg bg-purple-accent text-white">Add to Corpus</button>
          <button id="rebuildSmallBtn" class="px-4 py-2 rounded-lg border border-gray-300 bg-white">Rebuild Index</button>
        </div>
        <p id="scrapeHint" class="mt-2 text-xs text-gray-600">Tip: Add Wikipedia/academic pages first. Then test with copied text.</p>
      </div>
    </section>

    <!-- SIDEBAR -->
    <aside class="bg-white rounded-xl p-4 shadow space-y-4">
      <div>
        <h4 id="summaryTitle" class="text-sm font-semibold text-gray-800">Scan Summary</h4>
        <div id="summaryBox" class="mt-3 text-sm text-gray-600">No scan yet</div>
      </div>

      <div>
        <h4 id="recentTitle" class="text-sm font-semibold text-gray-800">Recent Scans</h4>
        <ul id="historyList" class="mt-3 space-y-2 max-h-48 overflow-auto text-sm"></ul>
      </div>

      <div>
        <h4 id="corpusTitle" class="text-sm font-semibold text-gray-800">Corpus Controls</h4>
        <div class="mt-2 space-y-2">
          <div class="text-xs text-gray-500"><span id="corpusCountLabel">Corpus count:</span> <span id="sidebarCorpusCount">—</span></div>
          <button id="rebuildBtn" class="w-full px-3 py-2 bg-purple-accent text-white rounded text-sm">Rebuild Index</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- RESULTS -->
  <section id="resultsPanel" class="max-w-6xl mx-auto px-4 pb-10 hidden">
    <div class="bg-white rounded-xl p-6 shadow">
      <div class="flex items-center justify-between">
        <h3 id="resultsTitle" class="text-lg font-semibold">Scan Results</h3>
        <div id="overallBadge" class="text-sm font-semibold px-3 py-1 rounded-lg">—</div>
      </div>

      <div id="resultsSummaryCard" class="mt-4 p-4 rounded-xl border border-gray-200 bg-gray-50 hidden"></div>

      <div id="resultsContent" class="mt-4 grid grid-cols-1 gap-4"></div>
    </div>
  </section>

  <script>
    const backendUrl = "http://127.0.0.1:5000";
    const SCORE_THRESHOLDS = { low:30, med:60 };
    const UI_LANG_KEY = "ui_lang";

    // UI strings
    const STR = {
      en: {
        home: "Home",
        appName: "PlagAware",
        tag: "AI Plagiarism Dashboard",
        heroTitle: "Plagiarism Detection (Multilingual + AI)",
        heroDesc: "Paste text or upload files. We translate to English (if needed) and detect semantic plagiarism using embeddings + FAISS.",
        upload: "Upload",
        sources: "Sources",
        highlight: "Highlight",
        uploadDesc: "PDF / DOCX / TXT",
        sourcesDesc: "URL + Title",
        highlightDesc: "Matched spans",
        pasteText: "Paste text",
        limit: "Up to 10,000 chars",
        placeholder: "Paste your text here...",
        check: "Check Text",
        language: "Language",
        drop: "Drag & drop or click to upload",
        scrapeLabel: "Add online sources to corpus (one URL per line)",
        addCorpus: "Add to Corpus",
        rebuild: "Rebuild Index",
        scrapeHint: "Tip: Add Wikipedia/academic pages first. Then test with copied text.",
        summary: "Scan Summary",
        recent: "Recent Scans",
        corpus: "Corpus Controls",
        corpusCount: "Corpus count:",
        noScan: "No scan yet",
        noHistory: "No scans yet",
        results: "Scan Results",
        overall: "Overall similarity",
        most: "Most suspicious",
        high: "High-risk chunks (>60%)",
        chunk: "Chunk",
        noMatches: "No strong matches found for this chunk.",
        translatedNote: (code)=>`Translated to English (detected/requested: ${code}).`,
      },
      ar: {
        home: "الصفحة الرئيسية",
        appName: "بلاج أويـر",
        tag: "لوحة كشف الانتحال",
        heroTitle: "كشف الانتحال (متعدد اللغات + ذكاء اصطناعي)",
        heroDesc: "ألصق النص أو ارفع ملفًا. سنترجم للإنجليزية عند الحاجة ثم نكشف الانتحال الدلالي باستخدام FAISS و Embeddings.",
        upload: "رفع ملف",
        sources: "المصادر",
        highlight: "تمييز",
        uploadDesc: "PDF / DOCX / TXT",
        sourcesDesc: "رابط + عنوان",
        highlightDesc: "تمييز المقاطع المتطابقة",
        pasteText: "ألصق النص",
        limit: "حتى ١٠٬٠٠٠ حرف",
        placeholder: "ألصق النص هنا...",
        check: "فحص النص",
        language: "لغة النص",
        drop: "اسحب وأفلت أو اضغط لرفع ملف",
        scrapeLabel: "أضف مصادر للـ Corpus (رابط في كل سطر)",
        addCorpus: "إضافة للمصادر",
        rebuild: "إعادة بناء الفهرس",
        scrapeHint: "نصيحة: أضف صفحات ويكيبيديا/أكاديمية أولاً ثم اختبر بنص منسوخ.",
        summary: "ملخص الفحص",
        recent: "الفحوصات الأخيرة",
        corpus: "إعدادات الـ Corpus",
        corpusCount: "عدد المقاطع:",
        noScan: "لا يوجد فحص بعد",
        noHistory: "لا توجد فحوصات بعد",
        results: "نتائج الفحص",
        overall: "نسبة التشابه الإجمالية",
        most: "أكثر جزء مشبوه",
        high: "الأجزاء عالية الخطورة (>٦٠٪)",
        chunk: "جزء",
        noMatches: "لا توجد تطابقات قوية لهذا الجزء.",
        translatedNote: (code)=>`تمت الترجمة للإنجليزية (الكشف/المطلوب: ${code}).`,
      }
    };

    const inputText = document.getElementById('inputText');
    const checkTextBtn = document.getElementById('checkTextBtn');
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const dropLabel = document.getElementById('dropLabel');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBar = document.getElementById('uploadBar');

    const resultsPanel = document.getElementById('resultsPanel');
    const resultsContent = document.getElementById('resultsContent');
    const overallBadge = document.getElementById('overallBadge');
    const resultsSummaryCard = document.getElementById('resultsSummaryCard');

    const summaryBox = document.getElementById('summaryBox');
    const historyList = document.getElementById('historyList');

    const urlList = document.getElementById('urlList');
    const scrapeBtn = document.getElementById('scrapeBtn');
    const rebuildBtn = document.getElementById('rebuildBtn');
    const rebuildSmallBtn = document.getElementById('rebuildSmallBtn');
    const sidebarCorpusCount = document.getElementById('sidebarCorpusCount');

    function escapeHtml(s='') {
      return (''+s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }

    function getUiLang() {
      return localStorage.getItem(UI_LANG_KEY) || "en";
    }

    function applyUiLang(lang) {
      const t = STR[lang] || STR.en;

      document.documentElement.lang = (lang === "ar") ? "ar" : "en";
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";

      document.getElementById("appName").textContent = t.appName;
      document.getElementById("appTagline").textContent = t.tag;
      document.getElementById("homeLink").textContent = t.home;

      document.getElementById("heroTitle").textContent = t.heroTitle;
      document.getElementById("heroDesc").textContent = t.heroDesc;

      document.getElementById("card1Title").textContent = t.upload;
      document.getElementById("card2Title").textContent = t.sources;
      document.getElementById("card3Title").textContent = t.highlight;
      document.getElementById("card1Desc").textContent = t.uploadDesc;
      document.getElementById("card2Desc").textContent = t.sourcesDesc;
      document.getElementById("card3Desc").textContent = t.highlightDesc;

      document.getElementById("pasteTitle").textContent = t.pasteText;
      document.getElementById("limitText").textContent = t.limit;
      inputText.placeholder = t.placeholder;

      checkTextBtn.textContent = t.check;
      document.getElementById("langLabel").textContent = t.language;
      dropLabel.textContent = t.drop;

      document.getElementById("scrapeLabel").textContent = t.scrapeLabel;
      scrapeBtn.textContent = t.addCorpus;
      rebuildSmallBtn.textContent = t.rebuild;
      rebuildBtn.textContent = t.rebuild;
      document.getElementById("scrapeHint").textContent = t.scrapeHint;

      document.getElementById("summaryTitle").textContent = t.summary;
      document.getElementById("recentTitle").textContent = t.recent;
      document.getElementById("corpusTitle").textContent = t.corpus;
      document.getElementById("corpusCountLabel").textContent = t.corpusCount;
      document.getElementById("resultsTitle").textContent = t.results;

      // Button text
      document.getElementById("uiLangToggle").textContent = (lang === "ar") ? "EN" : "AR";

      // Update “No scan yet” if no scan has been performed
      if (!window.__had_scan) {
        summaryBox.textContent = t.noScan;
      }

      // Refresh history text if empty
      renderHistory(JSON.parse(localStorage.getItem('scan_history') || '[]'));
    }

    document.getElementById("uiLangToggle").addEventListener("click", () => {
      const cur = getUiLang();
      const next = (cur === "en") ? "ar" : "en";
      localStorage.setItem(UI_LANG_KEY, next);
      applyUiLang(next);
      // if we already have results on screen, re-render them in new language
      if (window.__last_result) renderResults(window.__last_result);
    });

    // highlight spans
    function renderWithHighlights(text, spans) {
      if (!text) return '';
      if (!spans || !spans.length) return escapeHtml(text);

      let out = "";
      let last = 0;
      spans.forEach(sp => {
        const start = Math.max(0, Math.min(text.length, sp.start));
        const end = Math.max(0, Math.min(text.length, sp.end));
        if (start > last) out += escapeHtml(text.slice(last, start));
        out += `<mark class="rounded px-1 bg-yellow-200">${escapeHtml(text.slice(start, end))}</mark>`;
        last = end;
      });
      if (last < text.length) out += escapeHtml(text.slice(last));
      return out;
    }

    // History
    function loadHistory() {
      const h = JSON.parse(localStorage.getItem('scan_history') || '[]');
      renderHistory(h);
    }
    function saveToHistory(item) {
      const h = JSON.parse(localStorage.getItem('scan_history') || '[]');
      h.unshift(item);
      if (h.length > 25) h.pop();
      localStorage.setItem('scan_history', JSON.stringify(h));
      renderHistory(h);
    }
    function renderHistory(h) {
      const lang = getUiLang();
      const t = STR[lang] || STR.en;

      historyList.innerHTML = '';
      if (!h.length) {
        historyList.innerHTML = `<li class="text-xs text-gray-400">${t.noHistory}</li>`;
        return;
      }
      h.forEach((it) => {
        const li = document.createElement('li');
        li.innerHTML = `<button class="w-full text-left text-sm px-2 py-2 rounded hover:bg-gray-100">${escapeHtml(it.label)} · <span class="text-xs text-gray-500">${escapeHtml(it.date)}</span></button>`;
        li.querySelector('button').addEventListener('click', ()=> {
          renderResults(it.data);
          summaryBox.innerHTML = `<div class="text-sm font-medium">${escapeHtml(it.label)}</div><div class="text-xs text-gray-500">${escapeHtml(it.date)}</div>`;
        });
        historyList.appendChild(li);
      });
    }

    function setLoading(on, label='Scanning...') {
      if (on) {
        checkTextBtn.disabled = true;
        uploadProgress.classList.add('hidden');
        resultsPanel.classList.add('hidden');
        summaryBox.innerHTML = `<div class="text-sm text-gray-500">${escapeHtml(label)}</div>`;
      } else {
        checkTextBtn.disabled = false;
      }
    }

    async function fetchCorpusCount() {
      try {
        const res = await fetch(`${backendUrl}/rebuild-index`, { method: 'POST' });
        const j = await res.json();
        const count = j.corpus_count ?? 0;
        sidebarCorpusCount.textContent = `${count}`;
      } catch(e) {
        sidebarCorpusCount.textContent = '—';
      }
    }

    async function checkText() {
      const text = inputText.value.trim();
      const language = document.getElementById('languageSelect').value;
      if (!text) return alert('Please paste some text to scan.');

      setLoading(true, 'Analyzing text…');
      try {
        const res = await fetch(`${backendUrl}/check-text`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, language })
        });
        const j = await res.json();
        if (j.error) { setLoading(false); alert(j.error); return; }

        setLoading(false);
        renderResults(j);

        window.__had_scan = true;
        window.__last_result = j;

        saveToHistory({ label: 'Text scan', date: new Date().toLocaleString(), data: j });
      } catch (err) {
        setLoading(false);
        alert('Could not reach backend. Is the server running?');
        console.error(err);
      }
    }

    function uploadFileWithProgress(file, language) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const fd = new FormData();
        fd.append('file', file);
        fd.append('language', language || 'auto');
        xhr.open('POST', `${backendUrl}/check-file`, true);

        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            uploadProgress.classList.remove('hidden');
            uploadBar.style.width = pct + '%';
          }
        };

        xhr.onload = function() {
          uploadProgress.classList.add('hidden');
          uploadBar.style.width = '0%';
          if (xhr.status >= 200 && xhr.status < 300) {
            try { resolve(JSON.parse(xhr.responseText)); }
            catch(e) { reject(e); }
          } else reject(new Error('Upload failed: ' + xhr.status));
        };
        xhr.onerror = function() { uploadProgress.classList.add('hidden'); reject(new Error('Network error')); };
        xhr.send(fd);
      });
    }

    async function handleFileUpload(file) {
      setLoading(true, 'Uploading file & scanning...');
      try {
        const language = document.getElementById('languageSelect').value;
        const result = await uploadFileWithProgress(file, language);
        if (result.error) { setLoading(false); alert(result.error); return; }

        setLoading(false);
        renderResults(result);

        window.__had_scan = true;
        window.__last_result = result;

        saveToHistory({ label: `File: ${file.name}`, date: new Date().toLocaleString(), data: result });
      } catch(e) {
        setLoading(false);
        alert('Upload or scan failed: ' + (e.message || e));
        console.error(e);
      }
    }

    // Dropzone
    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('dragover', (e)=> { e.preventDefault(); dropZone.classList.add('ring-2','ring-purple-accent/30'); });
    dropZone.addEventListener('dragleave', ()=> { dropZone.classList.remove('ring-2','ring-purple-accent/30'); });
    dropZone.addEventListener('drop', async (e)=> {
      e.preventDefault();
      dropZone.classList.remove('ring-2','ring-purple-accent/30');
      const f = e.dataTransfer.files[0];
      if (!f) return;
      dropLabel.textContent = f.name;
      await handleFileUpload(f);
    });
    fileInput.addEventListener('change', async ()=> {
      const f = fileInput.files[0];
      if (!f) return;
      dropLabel.textContent = f.name;
      await handleFileUpload(f);
    });

    function renderResults(data) {
      const lang = getUiLang();
      const t = STR[lang] || STR.en;

      resultsPanel.classList.remove('hidden');
      resultsContent.innerHTML = '';

      const score = data.overall_score ?? 0;
      let badgeClass = 'text-green-700 bg-green-50';
      if (score > SCORE_THRESHOLDS.med) badgeClass = 'text-red-700 bg-red-50';
      else if (score > SCORE_THRESHOLDS.low) badgeClass = 'text-yellow-700 bg-yellow-50';

      overallBadge.className = `text-sm font-semibold px-3 py-1 rounded-lg ${badgeClass}`;
      overallBadge.textContent = `${score}% — ${data.message || ''}`;

      const usedTranslation = !!data.used_translation;
      const detected = data.detected_language || data.requested_language || 'auto';

      summaryBox.innerHTML = `
        <div class="text-sm font-medium">${escapeHtml(new Date().toLocaleString())}</div>
        <div class="text-xs text-gray-500">${escapeHtml(data.message || '')}</div>
        ${usedTranslation ? `<div class="mt-1 text-xs text-purple-700">${escapeHtml(t.translatedNote(detected))}</div>` : ''}
      `;

      const details = data.details || [];
      let maxSim = 0, maxChunk = -1, highCount = 0;
      details.forEach((d, i) => {
        const sim = (d.best_similarity ?? 0) * 100;
        if (sim > maxSim) { maxSim = sim; maxChunk = i; }
        if (sim > SCORE_THRESHOLDS.med) highCount++;
      });

      resultsSummaryCard.classList.remove('hidden');
      resultsSummaryCard.innerHTML = `
        <div class="flex flex-wrap gap-4 items-center justify-between">
          <div class="text-xs text-gray-600">${t.overall}: <span class="font-semibold text-gray-900">${Number(score).toFixed(2)}%</span></div>
          <div class="text-xs text-gray-600">${t.most}: <span class="font-semibold text-gray-900">${maxChunk>=0 ? `${t.chunk} ${maxChunk+1} (${maxSim.toFixed(2)}%)` : '—'}</span></div>
          <div class="text-xs text-gray-600">${t.high}: <span class="font-semibold text-gray-900">${highCount}</span></div>
        </div>
      `;

      details.forEach((d, idx) => {
        const sim = (d.best_similarity ?? 0) * 100;

        let heatClass = 'heat-0';
        if (sim > 60) heatClass = 'heat-2';
        else if (sim > 30) heatClass = 'heat-1';

        const card = document.createElement('div');
        card.className = 'p-4 rounded-lg border border-gray-200 bg-gray-50';

        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${t.chunk} ${idx+1}</div>
            <div class="text-sm font-semibold">${sim.toFixed(2)}%</div>
          </div>
          <div class="mt-2 text-sm whitespace-pre-wrap">
            ${renderWithHighlights(d.chunk_text || '', d.highlights || [])}
          </div>
        `;

        if (d.matches && d.matches.length) {
          const ul = document.createElement('ul');
          ul.className = 'mt-3 text-xs list-disc ml-5';

          d.matches.slice(0,3).forEach(m => {
            const li = document.createElement('li');
            const label = m.title || m.url || m.source || 'source';
            const safeLabel = escapeHtml(label);
            const safeUrl = m.url ? escapeHtml(m.url) : null;
            const snippet = escapeHtml((m.matched_text || '').slice(0, 140)) + '...';
            const simPct = ((m.similarity || 0) * 100).toFixed(2);

            li.innerHTML = safeUrl
              ? `<strong><a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="text-purple-accent hover:underline">${safeLabel}</a></strong>
                 — ${simPct}%<br><em class="text-gray-500">${snippet}</em>`
              : `<strong>${safeLabel}</strong> — ${simPct}%<br><em class="text-gray-500">${snippet}</em>`;

            ul.appendChild(li);
          });

          card.appendChild(ul);
        } else {
          const p = document.createElement('p');
          p.className = 'mt-3 text-xs text-gray-500';
          p.textContent = t.noMatches;
          card.appendChild(p);
        }

        const heat = document.createElement('div');
        heat.className = `mt-3 h-2 rounded-full ${heatClass}`;
        heat.style.width = Math.min(100, Math.max(6, sim)) + '%';
        card.appendChild(heat);

        resultsContent.appendChild(card);
      });

      resultsPanel.scrollIntoView({ behavior: 'smooth' });
    }

    // scrape + rebuild
    scrapeBtn.addEventListener('click', async () => {
      const raw = urlList.value.trim();
      if (!raw) return alert('Enter at least one URL (newline separated).');
      const urls = raw.split(/\n+/).map(u=>u.trim()).filter(Boolean);

      setLoading(true, 'Scraping sources...');
      try {
        const res = await fetch(`${backendUrl}/scrape`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });
        const j = await res.json();
        if (j.error) { setLoading(false); alert(j.error); return; }
        setLoading(false);
        alert(`Saved ${j.saved_count || 0} documents to corpus.`);
        await rebuildIndex();
      } catch(e) {
        setLoading(false);
        alert('Scrape failed. See console.');
        console.error(e);
      }
    });

    async function rebuildIndex() {
      try {
        setLoading(true, 'Rebuilding index...');
        const res = await fetch(`${backendUrl}/rebuild-index`, { method: 'POST' });
        const j = await res.json();
        setLoading(false);
        sidebarCorpusCount.textContent = `${j.corpus_count ?? 0}`;
        alert('Index rebuilt. Corpus size: ' + (j.corpus_count || 0));
      } catch(e) {
        setLoading(false);
        alert('Rebuild failed.');
        console.error(e);
      }
    }

    rebuildBtn.addEventListener('click', rebuildIndex);
    rebuildSmallBtn.addEventListener('click', rebuildIndex);
    checkTextBtn.addEventListener('click', checkText);

    // init
    window.__had_scan = false;
    loadHistory();
    fetchCorpusCount();
    applyUiLang(getUiLang());
  </script>
</body>
</html>










































