<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Plagiarism Detector — Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'purple-accent': '#7C3AED',
            'purple-accent-2': '#C084FC',
            'panel': '#F8FAFF',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] }
        }
      }
    }
  </script>
  <style>
    .heat-0 { background: linear-gradient(90deg,#ecfccb,#86efac); }
    .heat-1 { background: linear-gradient(90deg,#fef9c3,#facc15); }
    .heat-2 { background: linear-gradient(90deg,#fee2e2,#f43f5e); }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }

    /* highlight */
    mark.plag-mark { background: #fde68a; padding: 0 2px; border-radius: 4px; }
  </style>
</head>

<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">

  <!-- TOP NAVBAR (yours, with small AR button added) -->
  <nav class="bg-white/90 dark:bg-gray-900/90 border-b dark:border-gray-800 backdrop-blur sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-9 h-9 rounded-lg bg-purple-accent text-white flex items-center justify-center font-bold text-lg">
          AI
        </div>
        <div>
          <div class="font-extrabold text-lg text-gray-900 dark:text-white">PlagAware</div>
          <div id="subTitle" class="text-xs text-gray-500 dark:text-gray-400">AI Plagiarism Dashboard</div>
        </div>
      </div>

      <div class="flex items-center gap-2 text-sm">
        <a href="index.html" id="navHome" class="hidden sm:inline-block px-3 py-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
          Home
        </a>
        <a href="dashboard.html" id="navChecker" class="hidden sm:inline-block px-3 py-1 rounded-lg bg-purple-accent text-white font-semibold hover:opacity-95">
          Open Checker
        </a>

        <!-- Arabic toggle -->
        <button id="uiLangToggle" class="px-3 py-1 rounded-lg border dark:border-gray-700 bg-white dark:bg-gray-800 text-xs">
          AR
        </button>
      </div>
    </div>
  </nav>

  <!-- Layout: Sidebar + Main -->
  <div class="min-h-screen flex">

    <!-- SIDEBAR -->
    <aside class="w-72 bg-white dark:bg-gray-800 border-r dark:border-gray-700 hidden md:block">
      <div class="p-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 rounded-lg bg-purple-accent flex items-center justify-center text-white font-bold">AI</div>
          <div>
            <h1 class="text-lg font-extrabold text-gray-900 dark:text-white">PlagAware</h1>
            <p id="sideSub" class="text-xs text-gray-500 dark:text-gray-400">AI Plagiarism Dashboard</p>
          </div>
        </div>

        <nav class="mt-8 space-y-2">
          <button id="nav_scan" class="w-full text-left px-3 py-2 rounded-lg bg-purple-accent-2/10 text-sm font-medium text-purple-accent hover:bg-purple-accent-2/20">Scan</button>
          <button id="nav_corpus" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">Corpus</button>
          <button id="nav_history" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-sm">History</button>
        </nav>

        <div class="mt-8">
          <p id="corpusSizeLabel" class="text-xs text-gray-500 dark:text-gray-400">Corpus size:</p>
          <div id="corpusCount" class="mt-2 text-sm font-semibold text-gray-700 dark:text-gray-200">—</div>
          <button id="rebuildBtn" class="mt-3 w-full px-3 py-2 bg-purple-accent text-white rounded-lg text-sm">Rebuild Index</button>
        </div>

        <div class="mt-8 text-xs text-gray-400">Built for your university project • Local only</div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="flex-1 p-6">

      <header class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <h2 id="pageTitle" class="text-xl font-bold text-gray-900 dark:text-white">Scan · New</h2>
          <span id="pageHint" class="text-sm text-gray-500 dark:text-gray-400">Paste text or upload a document to detect plagiarism</span>
        </div>

        <div class="flex items-center space-x-4">
          <div class="hidden sm:flex items-center space-x-2 px-3 py-2 bg-white dark:bg-gray-800 rounded-lg border dark:border-gray-700">
            <label id="langLabel" class="text-xs text-gray-500 dark:text-gray-400 mr-2">Language (we’ll translate)</label>
            <select id="languageSelect" class="text-sm bg-transparent outline-none">
              <option value="auto">Detect</option>
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="hi">Hindi</option>
              <option value="zh-cn">Chinese (Simplified)</option>
              <option value="ar">Arabic</option>
              <option value="ru">Russian</option>
            </select>
          </div>

          <div class="flex items-center space-x-3">
            <button id="themeToggle" class="p-2 rounded-md bg-white dark:bg-gray-800 shadow-sm" title="Toggle theme">
              <svg class="w-5 h-5 text-gray-700 dark:text-gray-200" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 2a1 1 0 0 1 1 1v2a1 1 0 0 1-2 0V3a1 1 0 0 1 1-1zM5.636 4.222a1 1 0 1 1 1.414-1.414L8.05 4.81a1 1 0 0 1-1.414 1.414L5.636 4.222zM2 12a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1z"/>
              </svg>
            </button>
          </div>
        </div>
      </header>

      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <section class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl p-6 shadow">
          <div class="flex items-start justify-between">
            <h3 id="pasteTitle" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Paste text</h3>
            <div id="limitText" class="text-sm text-gray-500 dark:text-gray-400">Up to 10,000 chars</div>
          </div>

          <textarea id="inputText" maxlength="10000" rows="10"
            class="w-full mt-4 p-4 rounded-lg border dark:border-gray-700 dark:bg-gray-900 text-sm"
            placeholder="Paste your text here..."></textarea>

          <div class="mt-4 flex items-center gap-3">
            <button id="checkTextBtn" class="px-5 py-2 rounded-lg bg-purple-accent text-white font-semibold hover:opacity-95">Check Text</button>

            <label id="dropZone" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-purple-accent-2/10 border border-dashed cursor-pointer text-sm text-gray-700 dark:text-gray-200">
              <input id="fileInput" type="file" accept=".pdf,.docx,.txt" class="hidden" />
              <svg class="w-5 h-5 text-purple-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V8a4 4 0 018 0v8"/>
              </svg>
              <span id="dropLabel">Drag & drop or click to upload</span>
            </label>

            <div id="uploadProgress" class="hidden w-48 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
              <div id="uploadBar" class="h-2 bg-purple-accent" style="width:0%"></div>
            </div>
          </div>

          <div class="mt-5 p-4 rounded-lg bg-gray-50 dark:bg-gray-900 border dark:border-gray-700">
            <label id="scrapeLabel" class="text-sm font-medium">Add online sources to corpus (one URL per line)</label>
            <textarea id="urlList" rows="2" class="mt-2 w-full p-2 rounded border dark:bg-gray-900 text-sm" placeholder="https://example.com/article"></textarea>
            <div class="mt-3 flex gap-3">
              <button id="scrapeBtn" class="px-4 py-2 rounded-lg bg-purple-accent text-white">Add to Corpus</button>
              <button id="rebuildSmallBtn" class="px-4 py-2 rounded-lg border">Rebuild Index</button>
            </div>
            <p id="scrapeHint" class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              Adding URLs will attempt to scrape and save articles to the corpus directory on the server.
            </p>
          </div>
        </section>

        <aside class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow space-y-4">
          <div>
            <h4 id="summaryTitle" class="text-sm font-semibold text-gray-800 dark:text-gray-100">Scan Summary</h4>
            <div id="summaryBox" class="mt-3 text-sm text-gray-600 dark:text-gray-300">No scan yet</div>
          </div>

          <div>
            <h4 id="recentTitle" class="text-sm font-semibold text-gray-800 dark:text-gray-100">Recent Scans</h4>
            <ul id="historyList" class="mt-3 space-y-2 max-h-48 overflow-auto text-sm"></ul>
          </div>

          <div>
            <h4 id="corpusTitle" class="text-sm font-semibold text-gray-800 dark:text-gray-100">Corpus Controls</h4>
            <div class="mt-2 space-y-2">
              <div class="text-xs text-gray-500 dark:text-gray-400">
                <span id="corpusCountLabel">Corpus count:</span> <span id="sidebarCorpusCount">—</span>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <section id="resultsPanel" class="mt-6 bg-white dark:bg-gray-800 rounded-xl p-6 shadow hidden">
        <div class="flex items-center justify-between">
          <h3 id="resultsTitle" class="text-lg font-semibold">Scan Results</h3>
          <div id="overallBadge" class="text-sm font-semibold px-3 py-1 rounded-lg">—</div>
        </div>

        <div id="resultsContent" class="mt-4 grid grid-cols-1 gap-4"></div>
      </section>

    </div>
  </div>

  <script>
    /* ====== Config ====== */
    const backendUrl = "http://127.0.0.1:5000";
    const SCORE_THRESHOLDS = { low:30, med:60 };
    const UI_LANG_KEY = "ui_lang";
    window.__lastResult = null;

    /* ====== i18n strings (English/Arabic) ====== */
    const STR = {
      en: {
        home: "Home",
        checker: "Open Checker",
        subtitle: "AI Plagiarism Dashboard",
        pageTitle: "Scan · New",
        pageHint: "Paste text or upload a document to detect plagiarism",
        langLabel: "Language (we’ll translate)",
        pasteTitle: "Paste text",
        limit: "Up to 10,000 chars",
        check: "Check Text",
        drop: "Drag & drop or click to upload",
        scrapeLabel: "Add online sources to corpus (one URL per line)",
        addCorpus: "Add to Corpus",
        rebuild: "Rebuild Index",
        scrapeHint: "Adding URLs will attempt to scrape and save articles to the corpus directory on the server.",
        summary: "Scan Summary",
        noScan: "No scan yet",
        recent: "Recent Scans",
        corpusControls: "Corpus Controls",
        corpusSize: "Corpus size:",
        corpusCount: "Corpus count:",
        results: "Scan Results",
        chunk: (n)=>`Chunk ${n}`,
        noMatches: "No strong matches found for this chunk.",
        translated: (lang)=>`Text was translated to EN before analysis (detected/requested: ${lang}).`,
        analyzing: "Analyzing text…",
        uploading: "Uploading file & scanning...",
        scraping: "Scraping sources...",
        rebuilding: "Rebuilding index..."
      },
      ar: {
        home: "الصفحة الرئيسية",
        checker: "فتح الفاحص",
        subtitle: "لوحة كشف الانتحال",
        pageTitle: "فحص · جديد",
        pageHint: "ألصق النص أو ارفع ملفًا للكشف عن الانتحال",
        langLabel: "لغة النص (سنترجم)",
        pasteTitle: "ألصق النص",
        limit: "حتى ١٠٬٠٠٠ حرف",
        check: "فحص النص",
        drop: "اسحب وأفلت أو اضغط لرفع ملف",
        scrapeLabel: "أضف مصادر من الإنترنت إلى المستودع (رابط في كل سطر)",
        addCorpus: "إضافة للمستودع",
        rebuild: "إعادة بناء الفهرس",
        scrapeHint: "سيتم محاولة استخراج النص وحفظه داخل مجلد المستودع على الخادم.",
        summary: "ملخص الفحص",
        noScan: "لا يوجد فحص بعد",
        recent: "الفحوصات الأخيرة",
        corpusControls: "إدارة المستودع",
        corpusSize: "حجم المستودع:",
        corpusCount: "عدد المقاطع:",
        results: "نتائج الفحص",
        chunk: (n)=>`المقطع ${n}`,
        noMatches: "لا توجد مطابقات قوية لهذا المقطع.",
        translated: (lang)=>`تمت الترجمة إلى الإنجليزية قبل التحليل (اللغة المكتشفة/المختارة: ${lang}).`,
        analyzing: "جارٍ تحليل النص…",
        uploading: "جارٍ رفع الملف وفحصه...",
        scraping: "جارٍ استخراج المصادر...",
        rebuilding: "جارٍ إعادة بناء الفهرس..."
      }
    };

    function getUILang() {
      return localStorage.getItem(UI_LANG_KEY) || "en";
    }
    function setUILang(lang) {
      localStorage.setItem(UI_LANG_KEY, lang);
    }
    function applyLangUI() {
      const lang = getUILang();
      const s = STR[lang];

      document.documentElement.lang = (lang === "ar") ? "ar" : "en";
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";

      document.getElementById("navHome").textContent = s.home;
      document.getElementById("navChecker").textContent = s.checker;
      document.getElementById("subTitle").textContent = s.subtitle;
      document.getElementById("sideSub").textContent = s.subtitle;

      document.getElementById("pageTitle").textContent = s.pageTitle;
      document.getElementById("pageHint").textContent = s.pageHint;
      document.getElementById("langLabel").textContent = s.langLabel;
      document.getElementById("pasteTitle").textContent = s.pasteTitle;
      document.getElementById("limitText").textContent = s.limit;
      document.getElementById("checkTextBtn").textContent = s.check;
      document.getElementById("dropLabel").textContent = s.drop;

      document.getElementById("scrapeLabel").textContent = s.scrapeLabel;
      document.getElementById("scrapeBtn").textContent = s.addCorpus;
      document.getElementById("rebuildSmallBtn").textContent = s.rebuild;
      document.getElementById("rebuildBtn").textContent = s.rebuild;
      document.getElementById("scrapeHint").textContent = s.scrapeHint;

      document.getElementById("summaryTitle").textContent = s.summary;
      document.getElementById("recentTitle").textContent = s.recent;
      document.getElementById("corpusTitle").textContent = s.corpusControls;
      document.getElementById("corpusSizeLabel").textContent = s.corpusSize;
      document.getElementById("corpusCountLabel").textContent = s.corpusCount;
      document.getElementById("resultsTitle").textContent = s.results;

      const toggle = document.getElementById("uiLangToggle");
      toggle.textContent = (lang === "ar") ? "EN" : "AR";

      // re-render last result to translate result-box labels too
      if (window.__lastResult) renderResults(window.__lastResult);
      // if no scan yet, keep localized
      if (!window.__lastResult) summaryBox.textContent = s.noScan;
    }

    /* ====== DOM refs ====== */
    const inputText = document.getElementById('inputText');
    const checkTextBtn = document.getElementById('checkTextBtn');
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const dropLabel = document.getElementById('dropLabel');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBar = document.getElementById('uploadBar');
    const resultsPanel = document.getElementById('resultsPanel');
    const resultsContent = document.getElementById('resultsContent');
    const overallBadge = document.getElementById('overallBadge');
    const summaryBox = document.getElementById('summaryBox');
    const historyList = document.getElementById('historyList');
    const corpusCount = document.getElementById('corpusCount');
    const sidebarCorpusCount = document.getElementById('sidebarCorpusCount');
    const urlList = document.getElementById('urlList');
    const scrapeBtn = document.getElementById('scrapeBtn');
    const rebuildBtn = document.getElementById('rebuildBtn');
    const rebuildSmallBtn = document.getElementById('rebuildSmallBtn');
    const themeToggle = document.getElementById('themeToggle');

    /* ====== Theme toggle (your original) ====== */
    if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
    themeToggle.addEventListener('click', ()=>{
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    /* ====== Arabic toggle ====== */
    document.getElementById("uiLangToggle").addEventListener("click", () => {
      const next = (getUILang() === "en") ? "ar" : "en";
      setUILang(next);
      applyLangUI();
    });

    /* ====== history ====== */
    function loadHistory() {
      const h = JSON.parse(localStorage.getItem('scan_history') || '[]');
      renderHistory(h);
    }
    function saveToHistory(item) {
      const h = JSON.parse(localStorage.getItem('scan_history') || '[]');
      h.unshift(item);
      if (h.length > 25) h.pop();
      localStorage.setItem('scan_history', JSON.stringify(h));
      renderHistory(h);
    }
    function renderHistory(h) {
      const s = STR[getUILang()];
      historyList.innerHTML = '';
      if (!h.length) {
        historyList.innerHTML = `<li class="text-xs text-gray-400">${escapeHtml(s.noScan)}</li>`;
        return;
      }
      h.forEach((it) => {
        const li = document.createElement('li');
        li.innerHTML = `<button class="w-full text-left text-sm px-2 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">${escapeHtml(it.label)} · <span class="text-xs text-gray-500">${escapeHtml(it.date)}</span></button>`;
        li.querySelector('button').addEventListener('click', ()=> {
          window.__lastResult = it.data;
          renderResults(it.data);
        });
        historyList.appendChild(li);
      });
    }

    /* ====== corpus count ====== */
    async function fetchCorpusCount() {
      try {
        const res = await fetch(`${backendUrl}/rebuild-index`, { method: 'POST' });
        const j = await res.json();
        const count = j.corpus_count ?? 0;
        corpusCount.textContent = `${count} chunks`;
        sidebarCorpusCount.textContent = `${count}`;
      } catch(e) {
        corpusCount.textContent = '—';
        sidebarCorpusCount.textContent = '—';
      }
    }

    /* ====== loading UI ====== */
    function setLoading(on, label) {
      const s = STR[getUILang()];
      const msg = label || s.analyzing;
      if (on) {
        checkTextBtn.disabled = true;
        uploadProgress.classList.add('hidden');
        resultsPanel.classList.add('hidden');
        summaryBox.innerHTML = `<div class="text-sm text-gray-500">${escapeHtml(msg)}</div>`;
      } else {
        checkTextBtn.disabled = false;
      }
    }

    /* ====== check text ====== */
    async function checkText() {
      const s = STR[getUILang()];
      const text = inputText.value.trim();
      const language = document.getElementById('languageSelect').value;
      if (!text) return alert('Please paste some text to scan.');

      setLoading(true, s.analyzing);

      try {
        const res = await fetch(`${backendUrl}/check-text`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, language })
        });
        const j = await res.json();
        if (j.error) {
          setLoading(false);
          alert(j.error);
          return;
        }
        setLoading(false);
        window.__lastResult = j;
        renderResults(j);
        saveToHistory({ label: 'Text scan', date: new Date().toLocaleString(), data: j });
      } catch (err) {
        setLoading(false);
        alert('Could not reach backend. Is the server running?');
        console.error(err);
      }
    }

    /* ====== upload with progress ====== */
    function uploadFileWithProgress(file, language) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const fd = new FormData();
        fd.append('file', file);
        fd.append('language', language || 'auto');

        xhr.open('POST', `${backendUrl}/check-file`, true);

        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            uploadProgress.classList.remove('hidden');
            uploadBar.style.width = pct + '%';
          }
        };

        xhr.onload = function() {
          uploadProgress.classList.add('hidden');
          uploadBar.style.width = '0%';
          if (xhr.status >= 200 && xhr.status < 300) {
            try { resolve(JSON.parse(xhr.responseText)); }
            catch(e) { reject(e); }
          } else {
            reject(new Error('Upload failed: ' + xhr.status));
          }
        };

        xhr.onerror = function() { uploadProgress.classList.add('hidden'); reject(new Error('Network error')); };
        xhr.send(fd);
      });
    }

    async function handleFileUpload(file) {
      const s = STR[getUILang()];
      setLoading(true, s.uploading);
      try {
        const language = document.getElementById('languageSelect').value;
        const result = await uploadFileWithProgress(file, language);
        if (result.error) {
          setLoading(false);
          alert(result.error);
          return;
        }
        setLoading(false);
        window.__lastResult = result;
        renderResults(result);
        saveToHistory({ label: `File: ${file.name}`, date: new Date().toLocaleString(), data: result });
      } catch(e) {
        setLoading(false);
        alert('Upload or scan failed: ' + (e.message || e));
        console.error(e);
      }
    }

    /* ====== dropzone ====== */
    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('dragover', (e)=> { e.preventDefault(); dropZone.classList.add('ring-2','ring-purple-accent/30'); });
    dropZone.addEventListener('dragleave', ()=> { dropZone.classList.remove('ring-2','ring-purple-accent/30'); });
    dropZone.addEventListener('drop', async (e)=> {
      e.preventDefault();
      dropZone.classList.remove('ring-2','ring-purple-accent/30');
      const f = e.dataTransfer.files[0];
      if (!f) return;
      dropLabel.textContent = f.name;
      await handleFileUpload(f);
    });
    fileInput.addEventListener('change', async ()=> {
      const f = fileInput.files[0];
      if (!f) return;
      dropLabel.textContent = f.name;
      await handleFileUpload(f);
    });

    /* ====== highlight renderer ====== */
    function renderWithHighlights(text, spans) {
      if (!text) return '';
      if (!spans || !spans.length) return escapeHtml(text);

      let out = '';
      let last = 0;

      const safeSpans = spans
        .filter(sp => typeof sp.start === 'number' && typeof sp.end === 'number')
        .map(sp => ({ start: Math.max(0, Math.min(text.length, sp.start)), end: Math.max(0, Math.min(text.length, sp.end)) }))
        .filter(sp => sp.end > sp.start)
        .sort((a,b)=>a.start-b.start);

      for (const sp of safeSpans) {
        if (sp.start > last) out += escapeHtml(text.slice(last, sp.start));
        out += `<mark class="plag-mark">${escapeHtml(text.slice(sp.start, sp.end))}</mark>`;
        last = sp.end;
      }
      if (last < text.length) out += escapeHtml(text.slice(last));
      return out;
    }

    /* ====== render results ====== */
    function renderResults(data) {
      const s = STR[getUILang()];
      resultsPanel.classList.remove('hidden');
      resultsContent.innerHTML = '';

      const score = data.overall_score ?? 0;
      let colorClass = 'text-green-600 bg-green-50';
      if (score > SCORE_THRESHOLDS.med) colorClass = 'text-red-600 bg-red-50';
      else if (score > SCORE_THRESHOLDS.low) colorClass = 'text-yellow-600 bg-yellow-50';

      overallBadge.className = `text-sm font-semibold px-3 py-1 rounded-lg ${colorClass}`;
      overallBadge.textContent = `${score}% — ${data.message || ''}`;

      const usedTranslation = !!data.used_translation;
      const detected = data.detected_language || data.requested_language || 'auto';

      summaryBox.innerHTML = `
        <div class="text-sm font-medium">${escapeHtml(s.summary)}</div>
        <div class="text-xs text-gray-500">${escapeHtml(data.message || '')}</div>
        ${usedTranslation ? `<div class="mt-1 text-xs text-purple-700 dark:text-purple-300">${escapeHtml(s.translated(detected))}</div>` : ''}
      `;

      const details = data.details || [];
      details.forEach((d, idx) => {
        const sim = (d.best_similarity ?? 0) * 100;

        let heatClass = 'heat-0';
        if (sim > 60) heatClass = 'heat-2';
        else if (sim > 30) heatClass = 'heat-1';

        const card = document.createElement('div');
        card.className = 'p-4 rounded-lg border dark:border-gray-700 bg-gray-50 dark:bg-gray-900';

        // ✅ THIS is the important part: highlights come from backend as d.highlights
        const chunkHtml = renderWithHighlights(d.chunk_text || '', d.highlights || []);

        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">${escapeHtml(s.chunk(idx+1))}</div>
            <div class="text-sm font-semibold">${sim.toFixed(2)}%</div>
          </div>
          <div class="mt-2 text-sm whitespace-pre-wrap">${chunkHtml}</div>
        `;

        if (d.matches && d.matches.length) {
          const ul = document.createElement('ul');
          ul.className = 'mt-3 text-xs list-disc ml-5';

          d.matches.slice(0,3).forEach(m => {
            const li = document.createElement('li');

            const sourceLabel = m.title || m.url || m.source || 'source';
            const safeLabel = escapeHtml(sourceLabel);
            const safeUrl = m.url ? escapeHtml(m.url) : null;
            const snippet = escapeHtml((m.matched_text || '').slice(0,120)) + '...';
            const simPct = ((m.similarity || 0) * 100).toFixed(2);

            li.innerHTML = safeUrl
              ? `<strong><a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="text-purple-accent hover:underline">${safeLabel}</a></strong>
                 — ${simPct}%<br><em class="text-xs text-gray-500">${snippet}</em>`
              : `<strong>${safeLabel}</strong> — ${simPct}%<br><em class="text-xs text-gray-500">${snippet}</em>`;

            ul.appendChild(li);
          });
          card.appendChild(ul);
        } else {
          const p = document.createElement('p');
          p.className = 'mt-3 text-xs text-gray-500';
          p.textContent = s.noMatches;
          card.appendChild(p);
        }

        const heat = document.createElement('div');
        heat.className = `mt-3 h-2 rounded-full ${heatClass}`;
        heat.style.width = Math.min(100, Math.max(6, sim)) + '%';
        card.appendChild(heat);

        resultsContent.appendChild(card);
      });

      resultsPanel.scrollIntoView({ behavior: 'smooth' });
    }

    /* ====== scrape + rebuild ====== */
    scrapeBtn.addEventListener('click', async () => {
      const s = STR[getUILang()];
      const raw = urlList.value.trim();
      if (!raw) return alert('Enter at least one URL (newline separated).');
      const urls = raw.split(/\n+/).map(u=>u.trim()).filter(Boolean);

      setLoading(true, s.scraping);
      try {
        const res = await fetch(`${backendUrl}/scrape`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });
        const j = await res.json();
        if (j.error) { setLoading(false); alert(j.error); return; }
        setLoading(false);
        alert(`Saved ${j.saved_count || 0} documents to corpus.`);
        await rebuildIndex();
      } catch(e) {
        setLoading(false);
        alert('Scrape failed. See console.');
        console.error(e);
      }
    });

    async function rebuildIndex() {
      const s = STR[getUILang()];
      try {
        setLoading(true, s.rebuilding);
        const res = await fetch(`${backendUrl}/rebuild-index`, { method: 'POST' });
        const j = await res.json();
        setLoading(false);
        corpusCount.textContent = `${j.corpus_count ?? 0} chunks`;
        sidebarCorpusCount.textContent = `${j.corpus_count ?? 0}`;
        alert('Index rebuilt. Corpus size: ' + (j.corpus_count || 0));
      } catch(e) {
        setLoading(false);
        alert('Rebuild failed.');
        console.error(e);
      }
    }

    rebuildBtn.addEventListener('click', rebuildIndex);
    rebuildSmallBtn.addEventListener('click', rebuildIndex);
    checkTextBtn.addEventListener('click', checkText);

    function escapeHtml(s='') {
      return (''+s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }

    // Init
    loadHistory();
    fetchCorpusCount();
    applyLangUI();
  </script>
</body>
</html>












































